<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
    http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.2.xsd
    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd">
 
 	<bean id="props" class="ar.com.telecom.shiva.base.utils.UtilPropertiesHolder">
  		<property name="locations">
  			<list>
  				<value>classpath:shiva_${entorno}_interno.properties</value>
  				<value>file:${configuracion}</value>
  			</list>
  		</property>
	</bean>
	
 	<!-- Configurar todas las url que tienen que ser protegidas -->
	<!-- Los roles vienen del atributo "member" y se le prepone el texto "ROLE_" adelante -->
	<security:http auto-config="true" use-expressions="true" entry-point-ref="authenticationEntryPoint" >
	
		<security:access-denied-handler ref="accessDeniedHandler"/>
		
		<security:form-login login-page="/ingresar"
							 authentication-failure-handler-ref="customAuthenticationFailureHandler"
    						 default-target-url="/principal"/>
    	
    	<security:intercept-url pattern="/jsp/index.jsp" access="permitAll"/>
    	<security:intercept-url pattern="/*WS**" access="permitAll"/>
    	
    	<security:intercept-url pattern="/jsp/**" access="isAuthenticated()"/>
    	<security:intercept-url pattern="/principal/**" access="isAuthenticated()"/>
		<security:intercept-url pattern="/template/**" access="isAuthenticated()"/>
		<security:intercept-url pattern="/sesion/**" access="isAuthenticated()"/>
		
		<!-- hasRole('ROLE_SHIVADESARROLLO')  -->
		<security:intercept-url pattern="/bandeja-de-entrada*/**" access="isAuthenticated()"/>
		<security:intercept-url pattern="/boleta*/**" access="isAuthenticated()"/>
		<security:intercept-url pattern="/*conciliacion*/**" access="isAuthenticated()"/>
		<security:intercept-url pattern="/talonario*/**" access="isAuthenticated()"/>
		<security:intercept-url pattern="/valor*/**" access="isAuthenticated()"/>
		<security:intercept-url pattern="/operacion-masiva*/**" access="isAuthenticated()"/>
		<security:intercept-url pattern="/mantenimiento*/**" access="hasAnyRole('MANTENIMIENTO')"/>
		
		<security:csrf request-matcher-ref="csrfSecurityRequestMatcher" />
	</security:http>
	
	<!-- Para los Web services y algunas urls que no necesitan csrf -->
	<bean id="csrfSecurityRequestMatcher" class="ar.com.telecom.shiva.presentacion.seguridad.CsrfSecurityRequestMatcher">
		<property name="unprotectedUrls">
  			<list>
  				<value>/index.jsp</value>
  				<value>/ingresar</value>
  				<value>/j_spring_security_check</value>
  				<value>/regresar-bandeja-de-entrada</value>
  				<value>/valores-autorizacion</value>
  				<!-- Se agrega la busqueda de operaciones masivas como solucion temporal ya que al volver al mismo desde la edicion,daba un error
				 de Usuario No Autorizado -->
  				<value>/operacion-masiva-busqueda</value>
  			</list>
  		</property>
	</bean>
	
	<bean id="customAuthenticationFailureHandler" class="ar.com.telecom.shiva.presentacion.seguridad.CustomAuthenticationFailureHandler">
    	<property name="defaultFailureUrl" value="/errorLogin"/>
	</bean>
	
	<bean id="authenticationEntryPoint" class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint">
		<property name="loginFormUrl" value="/denegarAcceso" />
	</bean>
	
	<bean id="accessDeniedHandler" class="ar.com.telecom.shiva.presentacion.seguridad.AccesoDenegadoHandler">
    	<property name="accessDeniedUrl" value="/usuarioNoAutorizado" />
	</bean>

	<!-- 
	Para desarrollo utilizando un ldif local no necesita manager-dn ni manager-password. 
	Necesita root para que spring no utilice su default dc=springframework,dc=org
	Ejemplo: 
	<security:ldap-server id="ldapServer" ldif="classpath*:shiva.ldif" root="o=Telecom" />
		 
	Cuando haya un ldap externo, utilizar el siguiente ldap-server de ejemplo 
	<security:ldap-server id="ldapServer" url="ldap://127.0.0.1:389/o=telecom" manager-dn="cn=admin,o=Telecom" manager-password="admin" />
	-->
	
	<!-- Buscar el usuario que intente hacer login -->
	<!-- 
  	Para autenticacion:
	user-search-filter: atributo del nombre del usuario 
	user-search-base: ruta donde encontrar informacion
	La contraseÃ±a la maneja Spring
	 
	Para autorizacion:
	group-search-filter: atributo que contiene DN completo del usuario
	group-search-base: ruta donde encontrar informacion de roles
	group-role-attribute: atributo que contiene el tipo de rol
	role-prefix: prefijo que se le agrega al rol para utilizarlo en intercept-url
	
	user-search-filter="cn={0}"
	user-search-filter="uid={0}" necesita buscar por uid en vez de cn={0}
	
	Colocando esto, nos permite crear manualmente los perfiles del shiva desde un archivo de texto
	user-context-mapper-ref="ldapDesaMapper" : usarlo en caso de emergencia cuando no funcione el ldap  
 	-->
	
	<!-- Manejo de autenticacion/autorizacion -->
	<!-- Local sin LDAP -->
	<security:ldap-server id="ldapServer" 
		ldif="classpath*:shiva.ldif" root="${ldap.dn.root}" />
 		
	<security:authentication-manager alias="authenticationManager">
		<security:ldap-authentication-provider server-ref="ldapServer"
			user-search-base="ou=Usuarios"
            user-search-filter="uid={0}"
     		group-search-base="ou=Servicios"       
            group-search-filter="member={0}"
            user-context-mapper-ref="ldapDesaMapper"
		/>
		<security:authentication-provider ref="nullAuthenticationProvider"/>
	</security:authentication-manager>
		
	<bean id="ldapDesaMapper" class="ar.com.telecom.shiva.presentacion.seguridad.LdapDesaMapper" />
	<bean id="ldapMapper" class="ar.com.telecom.shiva.presentacion.seguridad.LdapMapper" />
		
	<bean id="nullAuthenticationProvider" 
		class="org.springframework.security.config.authentication.AuthenticationManagerBeanDefinitionParser.NullAuthenticationProvider" />
		
	<bean id="ldapServicio" class="ar.com.telecom.shiva.base.ldap.impl.LdapDummyServicioImpl" />
 		
</beans>