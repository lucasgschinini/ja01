package ar.com.telecom.shiva.base.jms.impl;

import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.TextMessage;

import org.springframework.beans.factory.NoSuchBeanDefinitionException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;
import org.springframework.jms.JmsException;
import org.springframework.jms.core.JmsTemplate;

import ar.com.telecom.shiva.base.constantes.Mensajes;
import ar.com.telecom.shiva.base.constantes.Propiedades;
import ar.com.telecom.shiva.base.excepciones.otros.JmsExcepcion;
import ar.com.telecom.shiva.base.jms.IControlJms;
import ar.com.telecom.shiva.base.jms.util.JmsMensaje;
import ar.com.telecom.shiva.base.jms.util.JmsPropiedades;
import ar.com.telecom.shiva.base.jms.util.mq.MQSeriesBase;
import ar.com.telecom.shiva.base.utils.logs.Traza;

import com.ibm.msg.client.wmq.WMQConstants;

public class ControlMqSeriesImpl implements IControlJms {

	private JmsTemplate jmsTemplate;
	
	private MQSeriesBase mqServidor;
	
	private JmsPropiedades jmsPropiedades;
	
	/**
	 * Constructor
	 */
	public ControlMqSeriesImpl() {
	}
	
	
	/****************************************************************************************
	 * Metodos con jmsTemplate
	 ***************************************************************************************/
	@Override
	public void enviarMensaje(String contenido, String contrato) throws JmsExcepcion {
		try {
			Traza.transaccionMQ(getClass(), "Pre-Salida: "+contenido);
			
			com.ibm.mq.jms.MQQueue mqDest = mqServidor.getQueueEmisor();
			mqDest.setMQMDWriteEnabled(true);
			mqDest.setMQMDReadEnabled(true);
			mqDest.setMQMDMessageContext(WMQConstants.WMQ_MDCTX_SET_ALL_CONTEXT);
			
			jmsTemplate.setDefaultDestination(mqDest);
			this.jmsPropiedades.setContrato(contrato);
			jmsTemplate.send(new JmsMensaje(new StringBuffer(contenido), this.jmsPropiedades));
			
			Traza.transaccionMQ(getClass(), "Salida Exitosa:\n"+contenido);
			
		} catch (JmsException | JMSException e) {
			Traza.error(getClass(),Mensajes.MQ_ERROR_ENVIAR_MENSAJE, e);
			throw new JmsExcepcion(Mensajes.MQ_ERROR_ENVIAR_MENSAJE, e);
		}
	}
	
	@Override
	public Message recibirMensaje() throws JmsExcepcion {
		try {
			com.ibm.mq.jms.MQQueue mqDest = mqServidor.getQueueReceptor();
			jmsTemplate.setDefaultDestination(mqDest);
			jmsTemplate.setReceiveTimeout(1000);
			
			Message message = jmsTemplate.receive();
			return message;
			
		} catch (JmsException e) {
			Traza.error(getClass(),Mensajes.MQ_ERROR_RECIBIR_MENSAJE, e);
			throw new JmsExcepcion(Mensajes.MQ_ERROR_RECIBIR_MENSAJE, e);
		}
	}
	
	
	@Override
	public JmsPropiedades getJmsPropiedadesContexto() {
		return jmsPropiedades;
	}
	
	/***************************************************************************************************************************************************
	 * Comunicacion MQ Sincronizada
	 */
	private static final String CONTEXT_JMS_BASE = "context/spring-jms-template.xml";
	
	@Override
	public String consultar(String contenido, String contrato) throws JmsExcepcion {
		ApplicationContext ctxJMS = new ClassPathXmlApplicationContext(CONTEXT_JMS_BASE);
		try {
			// Inicializo el contexto de Spring
			JmsTemplate jmsTemplateSync = (JmsTemplate) ctxJMS.getBean("micFacJmsTemplate");
			
			if (jmsTemplateSync==null) {
				Traza.error(getClass(),Mensajes.MQ_ERROR_ENVIAR_MENSAJE + " por ser el jmsTemplateSync vacio");
				throw new JmsExcepcion(Mensajes.MQ_ERROR_ENVIAR_MENSAJE + " por ser el jmsTemplateSync vacio");
			}
		
			try {
				
				com.ibm.mq.jms.MQQueue mqDest = mqServidor.getQueueEmisor();
				mqDest.setMQMDWriteEnabled(true);
				mqDest.setMQMDReadEnabled(true);
				mqDest.setMQMDMessageContext(WMQConstants.WMQ_MDCTX_SET_ALL_CONTEXT);
				this.jmsPropiedades.setContrato(contrato);
				
				com.ibm.mq.jms.MQQueue mqReply = mqServidor.getQueueReceptor();
				mqReply.setMQMDWriteEnabled(true);
				mqReply.setMQMDReadEnabled(true);
				mqReply.setMQMDMessageContext(WMQConstants.WMQ_MDCTX_SET_ALL_CONTEXT);
				
				Traza.transaccionMQ(getClass(), "Pre-Salida: "+contenido);
				
				String mensajeID = "";
				String mensajeCorrelationId = "";
				Message mensajeRecibido = null; 
				
				synchronized (this) {
					JmsMensaje messageCreator = 
							new JmsMensaje(new StringBuffer(contenido), this.jmsPropiedades, mqReply);
				
					//Envio el mensaje
					jmsTemplate.send(mqDest, messageCreator);
						
					//Obtengo el id del mensaje enviado
					mensajeID = messageCreator.getJMSMessageId();
					mensajeCorrelationId = "JMSMessageID='"+mensajeID+"'";
				}
				
				Traza.transaccionMQ(getClass(), "Salida Exitosa (Id Message: "+mensajeID+"):\n"+contenido);
				
				if (mensajeID != null) {
					
					int count = 1;
					while (mensajeRecibido==null && count <= 10) {
						
						Traza.transaccionMQ(getClass(), "Contador = " + count + " " + mensajeCorrelationId);
						jmsTemplate.setReceiveTimeout(new Long(Propiedades.SHIVA_PROPIEDADES.getString("mq.timeout")));
						mensajeRecibido = jmsTemplate.receiveSelected(mqReply, mensajeCorrelationId);
						count = count + 1;
					}
					
					if (mensajeRecibido != null) {
						if (mensajeRecibido instanceof TextMessage) {
							
							Traza.transaccionMQ(getClass(), "Entrada - Propiedades (Id Message: "+mensajeID+"): " + mensajeRecibido.toString());
							
							TextMessage tm = (TextMessage) mensajeRecibido;
				            String tmText = tm.getText();
				            
//				            if("CRM02S  09S010000600001".equals(contenido.substring(0, 23))){
//				            	tmText = "0018400                                                                                                                                                                                             000000100006.000010100006.0000109WR8201                                                               El ACUERDO no se encuentra facturandoWR8201                                                                                                                                                                                                                     El ACUERDO no se encuentra facturando02            FACTURADO00 POTENCIALRT000000903201103000000000000000OK                                                                                                                                                                                                                                                              00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00                     00          00000000000000000000                                                                                                               000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000";
//				            } else if("CRM02S  09S010000300001".equals(contenido.substring(0, 23))){
//				            	tmText = "0018400                                                                                                                                                                                             000000100003.000010100003.0000109OK                                                                                                        OK                                                                                                                                                                                                                                                              00                     01ACTIVO    00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00                     00          00000000000000000000                                                                                                          SHIVA000009000001FAC8888888888888880000097033888888888820120229  MIC777777777777DEB7777777777777777777779032777777777720100229     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000";
//				            } else if("CRM02S  09S000009000001".equals(contenido.substring(0, 23))){
//				            	tmText = "0018400                                                                                                                                                                                             00000             0000090.0000109OK                                                                                                        OK                                                                                                                                                                                                                                                              00                     01          00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00                     00          00000000000000000000                                                                                                               000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000";
//				            } else if("CRM02S  09S010000500002".equals(contenido.substring(0, 23))){
//				    			//respuesta simulacion TR2
//				    			tmText = "0018400                                                                                                                                                                                             000000100005.000020100005.0000209OK                                                                                                        OK                                                                                                                                                                                                                                                              02            FACTURADO02INCOMUNICA  00000000000000000000000000000000                                                                                                                                                                                                                                                              00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                02            FACTURADO00 POTENCIAL00000000000000000199WR8201                                                               El ACUERDO no se encuentra facturando     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000";
//				            } else if("CRM02S  09S010000500001".equals(contenido.substring(0, 23))){
//				    			//respuesta simulacion TR1
//				    			tmText = "0018400                                                                                                                                                                                             000000100005.000010100005.0000109OK                                                                                                        OK                                                                                                                                                                                                                                                              00                     01ACTIVO    NC000000000000000000000000000071OK                                                                                                                                                                                                                                                              00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00000000000000000000000000000000                                                                                                                                                                                                                                                                00                     00          00000000000000000000                                                                                                               000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000     000000000000   0000000000000000000000000000000000000000000";
//				            }
//				            tmText = "00193387800                                                                                                                                                                                         000000068227.000010068227.0000109OK7800OK SIMULACION                                                                                       ER8200EXISTE PAGO PARCIAL POSTERIOR                                                                                                                                                                                                                             0000000059000000000001PENDIENTE DE FACTURAR01ACTIVO      000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                  000000000000000000000000000000                                                                                                                                                                                                                                                                00                     00          00000000000000000000                                                                                                          SHIVA010000500002FAC985069689110106400006721500000001502015-10-29-15.16.20.637041     000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000000000000000000000                               000000000000   00000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ";
				            
				            // He visto que recibimos caracteres 0 (de tipo nulo(NUL)) 
				            // y en las trazas se eliminan estos caracteres por eso
				            // he decidido reemplazarlos por un espacio
				            char[] caracteres = tmText.toCharArray(); 
				    	    for (int i=0;i<caracteres.length;i++) {
				    	        if (caracteres[i] == 0) caracteres[i] = ' '; 
				    	    }
				    	    
				    	    String msg = new String(caracteres); 
				            Traza.transaccionMQ(getClass(), "Entrada - Contenido (Id Message: "+mensajeID+"):\n"+msg);
				            //System.out.println(Thread.currentThread().getName() + " - Entrada - Contenido (Id Message: "+mensajeID+")");
				            
				            //Ver Seguridad Informatica con respecto al JMSXAppID
				            //String app = mensajeRecibido.getStringProperty("JMSXAppID");
				            //Traza.advertencia(getClass(), "No puede procesar este mensaje recibido ya que no cumple con los requisitos de seguridad ("+app+")...");
				            			            
				            return msg;
						} else {
							Traza.error(getClass(), "Este mensaje recibido debe ser de tipo TextMessage");
						}
					} else {
						Traza.auditoria_MQ(getClass(), "No se ha encontrado la respuesta del mensaje ID: " +mensajeID);
					}
				}
				
				
			} catch (JmsException | JMSException e) {
				Traza.error(getClass(),Mensajes.MQ_ERROR_ENVIAR_MENSAJE, e);
				throw new JmsExcepcion(Mensajes.MQ_ERROR_ENVIAR_MENSAJE, e);
			}
		
		} catch (NoSuchBeanDefinitionException e) {
			Traza.error(getClass(),Mensajes.MQ_ERROR_ENVIAR_MENSAJE, e);
			throw new JmsExcepcion(Mensajes.MQ_ERROR_ENVIAR_MENSAJE, e);
		} finally {
			if (ctxJMS != null) {
				((ClassPathXmlApplicationContext)ctxJMS).close();
			}
		}
		
		return null;
	}

	/************************************************************************
	 * Getters/Setters
	 ***********************************************************************/
	public JmsTemplate getJmsTemplate() {
		return jmsTemplate;
	}
	public void setJmsTemplate(JmsTemplate jmsTemplate) {
		this.jmsTemplate = jmsTemplate;
	}


	public MQSeriesBase getMqServidor() {
		return mqServidor;
	}
	public void setMqServidor(MQSeriesBase mqServidor) {
		this.mqServidor = mqServidor;
	}


	public JmsPropiedades getJmsPropiedades() {
		return jmsPropiedades;
	}
	public void setJmsPropiedades(JmsPropiedades jmsPropiedades) {
		this.jmsPropiedades = jmsPropiedades;
	}
}
