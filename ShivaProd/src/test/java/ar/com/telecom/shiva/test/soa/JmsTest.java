package ar.com.telecom.shiva.test.soa;

import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.TextMessage;
import javax.sql.DataSource;

import org.junit.BeforeClass;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;
import org.springframework.mock.jndi.SimpleNamingContextBuilder;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import ar.com.telecom.shiva.base.constantes.Constantes;
import ar.com.telecom.shiva.base.constantes.Propiedades;
import ar.com.telecom.shiva.base.excepciones.NegocioExcepcion;
import ar.com.telecom.shiva.base.excepciones.otros.JmsExcepcion;
import ar.com.telecom.shiva.base.jms.IControlJms;
import ar.com.telecom.shiva.base.utils.logs.Traza;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = { "classpath*:spring-context.xml"})
public class JmsTest {

	//@Autowired
	//private IControlJms micImputacionCobrosControlMQ;
	
	//@Autowired
	//private IControlJms facConsultaAcuerdoControlMQ;
	
	@Autowired
	//@Qualifier("simulacionCobrosTest")
	private IControlJms micSimulacionCobrosControlMQ;
	
	private String micMensajeAEnviarSolicitud = 
			//"CRASYNC 02N000004100002SHIVA                   00000000          0000000000  00 RT0000050000000000000000003000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000";
		    "CRASYNC 04N000004100000SHIVA                   00000000          0000000000  00   0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000  0000000000000000000000000000000000000000";
	
	@SuppressWarnings("unused")
	private String micMensajeAEnviarRespuesta = 
			"CRASYNC                                                                                                                                 0000416S033                                                                                                                                                                                         000000000176.002540000176.0025405000000000000ERS033ID SHIVA NO EXISTE                                                                                  000000000000000000000000000000000000000000000                00000000";
	
	private String micMensajeSimulacion = "CRM01S  03S003379600001SHIVA   TF98506967911010720150619          0000023012SC0000000000N000000000000000000RT00000230120000000000001020000000000000000000000000RT00000230120000000000001020000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000  00000000000000000000000000000000000000000000000000";
	
	
	
	//Ejemplo de ICE
	private String iceMensajeAEnviarConsulta = 
			"CRM02H  0000006138                                                        01                                                                                                                                                                                                        ";
	

	@BeforeClass
	public static void setUpClass() throws Exception {
		System.setProperty(Constantes.PROPIEDAD_ENTORNO, "inte");
		System.setProperty(Constantes.PROPIEDAD_CONFIGURACION, "D:\\Telecom-Shiva-General\\ShivaDesarrollo\\src\\main\\resources\\shiva_inte.properties");
		
		ApplicationContext context = new ClassPathXmlApplicationContext("classpath:spring-test.xml");
        DataSource testDataSource = (DataSource) context.getBean("testDataSource");
        SimpleNamingContextBuilder builder = new SimpleNamingContextBuilder();
        builder.bind("java:jboss/datasources/ShivaDS", testDataSource);
        builder.activate();
    }
	
//	@Test
//	public void testMicEnviarMensajeAlContrato() throws JmsExcepcion {
//		micImputacionCobrosControlMQ.enviarMensaje(micMensajeAEnviarSolicitud, Propiedades.SHIVA_PROPIEDADES.getString("mq.mic.imputacion.adc.contrato.1"));
//		System.out.println("Test: Mensaje enviado al destino");
//	}
	
	
//	@Test
//	public void testMicEnviarMensajeAlReceptor() throws JmsExcepcion {
//		micImputacionCobrosControlMQ.enviarMensajeRecepcion(micMensajeAEnviarRespuesta, Propiedades.SHIVA_PROPIEDADES.getString("mq.mic.imputacion.adc.contrato.2"));
//		System.out.println("Test: Mensaje enviado al Receptor");
//	}
	
	@Test
	public void testMicEnviaryRecibirAsincronico() throws JmsExcepcion, JMSException {
		micSimulacionCobrosControlMQ.enviarMensaje(micMensajeSimulacion, Propiedades.SHIVA_PROPIEDADES.getString("mq.mic.simulacion.adc.servicio"));
		Traza.transaccionMQ(getClass(), "Test - MensajeEnviado");
		try {
			Thread.sleep(10000);
		} catch (InterruptedException ignore) {}
		
		boolean continuarBuscarMensajeMic = true;
		while (continuarBuscarMensajeMic) {
			
			Message mensajeRecibido = micSimulacionCobrosControlMQ.recibirMensaje();
			if (mensajeRecibido != null) {
				if (mensajeRecibido instanceof TextMessage) {
					Traza.transaccionMQ(getClass(), "Entrada - Propiedades: " + mensajeRecibido.toString());
					
					TextMessage tm = (TextMessage) mensajeRecibido;
		            String tmText = tm.getText();
		            
		            // He visto que recibimos caracteres 0 (de tipo nulo(NUL)) 
		            // y en las trazas se eliminan estos caracteres por eso
		            // he decidido reemplazarlos por un espacio
		            char[] caracteres = tmText.toCharArray(); 
		    	    for (int i=0;i<caracteres.length;i++) {
		    	        if (caracteres[i] == 0) caracteres[i] = ' '; 
		    	    }
		    	    
		    	    String msg = new String(caracteres); 
		            Traza.transaccionMQ(getClass(), "Entrada - Contenido:\n"+ msg);
		            Traza.transaccionMQ(getClass(), "Longitud:"+ msg.length());
				} else {
					Traza.error(getClass(), "Este mensaje recibido debe ser de tipo TextMessage");
				}
			} else {
				continuarBuscarMensajeMic = false;
				Traza.auditoria_MQ(getClass(), "La cola receptora de mensajes se encuentra vacia");
			}
		}
	}
	
	//@Test
	public void testFacConsulta() throws NegocioExcepcion {
		
		//Con mensaje simple del ice
		//facConsultaAcuerdoControlMQ.consultar(iceMensajeAEnviarConsulta, null);
		
		//System.out.println("Test: Mensaje consultado");
	}
	
}
